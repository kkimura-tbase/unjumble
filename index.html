<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èªé †ãƒ‘ã‚ºãƒ«ï½œã‚¿ãƒƒãƒã§ä¸¦ã¹æ›¿ãˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="å…¥åŠ›ã—ãŸè‹±æ–‡ã®å˜èªã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆã¦å‡ºé¡Œã€‚ã‚¿ãƒƒãƒæ“ä½œã§èªé †ã‚’ä¸¦ã¹æ›¿ãˆã¦è§£ç­”ã§ãã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µã‚¤ãƒˆã€‚" />
  <style>
    :root { --tile-gap: .5rem; }
    .tile { touch-action: manipulation; user-select: none; }
    .tile.selected { outline: 3px solid #60a5fa; }
    .tile.correct { background: #dcfce7; }
    .tile.wrong { background: #fee2e2; }
    .tile:active { transform: scale(0.98); }
    .token-row { display: flex; flex-wrap: wrap; gap: var(--tile-gap); }
    .dropzone { min-height: 3.5rem; border: 2px dashed rgba(0,0,0,.1); border-radius: .75rem; padding: .5rem; }
    .kbd { border: 1px solid rgba(0,0,0,.2); border-bottom-width: 3px; border-radius: .5rem; padding: 0 .4rem; font-weight: 600; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="max-w-5xl mx-auto px-4 py-6">
    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">èªé †ãƒ‘ã‚ºãƒ« <span class="text-slate-400 text-base align-middle">ï½œã‚¿ãƒƒãƒã§ä¸¦ã¹æ›¿ãˆ</span></h1>
    <p class="text-slate-600 mt-1">Wordwallã®ã€Œä¸¦ã¹æ›¿ãˆã€ã«ä¼¼ãŸã€æˆæ¥­ç”¨ã®è¶…è»½é‡ãƒ„ãƒ¼ãƒ«ã€‚1ãƒšãƒ¼ã‚¸å®Œçµãƒ»GitHub Pageså¯¾å¿œã€‚</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-24">
    <!-- Tabs -->
    <div class="flex gap-2 mb-4">
      <button id="tab-author" class="px-3 py-2 rounded-xl bg-white shadow text-sm font-semibold">ãƒ›ã‚¹ãƒˆï¼ˆå…ˆç”Ÿï¼‰</button>
      <button id="tab-play" class="px-3 py-2 rounded-xl bg-white shadow text-sm font-semibold">ç”Ÿå¾’ãƒ¢ãƒ¼ãƒ‰</button>
      <span class="ml-auto text-sm text-slate-500">v1.0</span>
    </div>

    <!-- Host Panel -->
    <section id="panel-author" class="bg-white rounded-2xl shadow p-4 md:p-6 space-y-4">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-2">è‹±æ–‡ã‚’1è¡Œã«1å•ãšã¤å…¥åŠ›</label>
          <textarea id="input-sentences" class="w-full h-44 rounded-xl border-slate-300 focus:ring-2 focus:ring-indigo-400 p-3" placeholder="ä¾‹\nI have a dream today.\nReading books makes me happy.\nWhen I was a child, I lived in Sapporo." spellcheck="false"></textarea>
          <div class="mt-2 flex flex-wrap gap-2 text-sm">
            <label class="inline-flex items-center gap-2"><input id="opt-punct" type="checkbox" class="accent-indigo-500" checked>å¥èª­ç‚¹ã‚’åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³ã«ã™ã‚‹</label>
            <label class="inline-flex items-center gap-2"><input id="opt-case" type="checkbox" class="accent-indigo-500" checked>å¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ã—ã¦æ¡ç‚¹</label>
            <label class="inline-flex items-center gap-2"><input id="opt-article" type="checkbox" class="accent-indigo-500">å† è©(a, an, the)ã‚‚ã‚·ãƒ£ãƒƒãƒ•ãƒ«</label>
          </div>
        </div>
        <div class="space-y-3">
          <div class="flex items-center gap-2">
            <button id="btn-build" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold shadow">å•é¡Œã‚’ä½œã‚‹</button>
            <button id="btn-demo" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold">ã‚µãƒ³ãƒ—ãƒ«ã‚’å…¥ã‚Œã‚‹</button>
            <button id="btn-export" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold" title="URLã«å•é¡Œã‚’åŸ‹ã‚è¾¼ã‚“ã§å…±æœ‰">å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>
          <p class="text-sm text-slate-600">âš™ï¸ å…±æœ‰ãƒªãƒ³ã‚¯ã¯ <code>?s=</code> ã«å•é¡Œã‚’åŸ‹ã‚è¾¼ã‚“ã URLã‚’ç”Ÿæˆã—ã¾ã™ã€‚Google Classroomã€Œå„ç”Ÿå¾’ã«ã‚³ãƒ”ãƒ¼ã€ã§é…å¸ƒã‚‚å¯ã€‚</p>
          <div class="text-sm bg-slate-50 rounded-xl p-3 leading-6">
            <div class="font-semibold mb-1">éŠã³æ–¹ï¼ˆç”Ÿå¾’ç”»é¢ï¼‰</div>
            <ul class="list-disc pl-5 space-y-1">
              <li>ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸã‚¿ã‚¤ãƒ«ã‚’<span class="font-semibold">ã‚¿ãƒƒãƒ—ã§å…¥ã‚Œæ›¿ãˆ</span>ã§ãã¾ã™ï¼ˆ2å›ã‚¿ãƒƒãƒ—ã§ã‚¹ãƒ¯ãƒƒãƒ—ï¼‰ã€‚</li>
              <li>ã¾ãŸã¯ã‚¿ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<span class="font-semibold">è§£ç­”æ¬„ã«é€ã‚‹</span>â†’æˆ»ã™ã§ä¸¦ã¹æ›¿ãˆã€‚</li>
              <li><span class="kbd">æ¡ç‚¹</span>ã§æ­£èª¤è¡¨ç¤ºã€‚<span class="kbd">æ¬¡ã¸</span>ã§æ¬¡ã®å•é¡Œã€‚</li>
            </ul>
            <div class="mt-2 text-xs text-slate-500">â€»å®Ÿé¨“çš„ãƒ‰ãƒ©ãƒƒã‚°å¯¾å¿œã¯ä»Šå¾Œè¿½åŠ äºˆå®šã€‚ç¾çŠ¶ã¯ã‚¿ãƒƒãƒ—æ“ä½œãŒç¢ºå®Ÿã§ã™ã€‚</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Play Panel -->
    <section id="panel-play" class="hidden bg-white rounded-2xl shadow p-4 md:p-6 space-y-4">
      <div class="flex items-center gap-3">
        <div class="text-sm text-slate-600">å•é¡Œ <span id="lbl-idx">0</span>/<span id="lbl-total">0</span></div>
        <div class="ml-auto flex items-center gap-2">
          <button id="btn-shuffle" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold">ã‚‚ã†ä¸€åº¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
          <button id="btn-reset" class="px-3 py-2 rounded-xl bg-slate-100 font-semibold">ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btn-check" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold">æ¡ç‚¹</button>
          <button id="btn-next" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-semibold">æ¬¡ã¸ â–¶</button>
        </div>
      </div>

      <!-- Sentence Prompt (optional hint) -->
      <div id="area-hint" class="text-slate-500 text-sm"></div>

      <!-- Dropzone style build mode -->
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-xs text-slate-500 mb-1">ğŸ”€ ä¸¦ã¹æ›¿ãˆï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠ â†’ è§£ç­”æ¬„ã¸ï¼‰</div>
          <div id="row-pool" class="token-row dropzone bg-slate-50"></div>
        </div>
        <div>
          <div class="text-xs text-slate-500 mb-1">ğŸ§© è§£ç­”æ¬„</div>
          <div id="row-answer" class="token-row dropzone"></div>
        </div>
      </div>

      <div id="area-feedback" class="mt-3 text-sm"></div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">
      Â© 2025 èªé †ãƒ‘ã‚ºãƒ« â€” single-file, privacy-friendly. No tracking.
    </footer>
  </main>

  <template id="tpl-tile">
    <button class="tile px-3 py-2 rounded-xl bg-white shadow border text-base font-semibold"></button>
  </template>

  <script>
    // --- Helpers ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const state = {
      items: [],            // [{tokens:[...], answer:[...] }]
      idx: 0,
      options: { punct:true, case:false, keepArticles:false },
    };

    function tokenize(str, {punct=true, keepArticles=false}={}){
      const cleaned = str.replace(/\s+/g,' ').trim();
      if(!punct){
        let tokens = cleaned.split(' ');
        if(!keepArticles) tokens = tokens; // already included in split; keep/shuffle with others by default
        return tokens.filter(t=>t.length);
      }
      // Split words and punctuation (keeps contractions like don't)
      const re = /([A-Za-z]+\'?[A-Za-z]*|[0-9]+|[^\sA-Za-z0-9])/g;
      const raw = cleaned.match(re) || [];
      // Optionally keep articles next to following noun by tagging; here we just return as is and may unsort later
      return raw;
    }

    function detokenize(tokens){
      // Join with spaces, but avoid spaces before punctuation
      let out = '';
      for(const t of tokens){
        if(/^[,.;:!?)]$/.test(t)){ out = out.trimEnd() + t + ' '; }
        else if(/^['\)]$/.test(t)) { out = out.trimEnd() + t + ' '; }
        else if(/^[\(]$/.test(t)) { out += t; }
        else { out += t + ' '; }
      }
      return out.trim();
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function eqTokens(a,b,{ignoreCase=false}){
      if(a.length!==b.length) return false;
      for(let i=0;i<a.length;i++){
        const x = ignoreCase? String(a[i]).toLowerCase(): String(a[i]);
        const y = ignoreCase? String(b[i]).toLowerCase(): String(b[i]);
        if(x!==y) return false;
      }
      return true;
    }

    function buildFromTextarea(){
      const text = $('#input-sentences').value.trim();
      if(!text){ alert('è‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      state.items = lines.map(line=>{
        const tokens = tokenize(line, {punct:$('#opt-punct').checked, keepArticles:$('#opt-article').checked});
        return { original: line, tokens, answer: tokens.slice() };
      });
      state.idx = 0;
      state.options = { punct: $('#opt-punct').checked, case: $('#opt-case').checked, keepArticles: $('#opt-article').checked };
      $('#lbl-total').textContent = state.items.length;
      switchTo('play');
      loadCurrent(true);
    }

    function loadCurrent(initialShuffle=false){
      const cur = state.items[state.idx];
      if(!cur) return;
      $('#lbl-idx').textContent = state.idx+1;
      $('#area-hint').textContent = '';
      renderRound(cur, initialShuffle);
    }

    function renderRound(item, doShuffle){
      const pool = $('#row-pool');
      const ans = $('#row-answer');
      pool.innerHTML=''; ans.innerHTML='';
      const order = doShuffle ? shuffle(item.tokens) : item.tokens.slice();
      // Ensure not equal to answer when shuffling
      if(doShuffle && eqTokens(order, item.answer, {ignoreCase: state.options.case})){
        order.reverse();
      }
      for(const tok of order){
        const node = tile(tok);
        pool.appendChild(node);
      }
      $('#area-feedback').innerHTML = '';
    }

    function tile(tok){
      const t = $('#tpl-tile').content.firstElementChild.cloneNode(true);
      t.textContent = tok;
      t.dataset.tok = tok;
      t.addEventListener('click', onTileClick);
      return t;
    }

    function onTileClick(e){
      const el = e.currentTarget;
      const parent = el.parentElement;
      const pool = $('#row-pool');
      const ans = $('#row-answer');
      // Swap select if in same row
      if(parent===pool){
        if(el.classList.contains('selected')){ el.classList.remove('selected'); return; }
        const prev = pool.querySelector('.tile.selected');
        if(prev && prev!==el){
          // swap positions
          const a = prev; const b = el;
          const aNext = a.nextSibling;
          const bNext = b.nextSibling;
          parent.insertBefore(b, aNext); // move b after a
          parent.insertBefore(a, bNext); // move a after original b position
          prev.classList.remove('selected');
        } else {
          // move to answer if any empty intention
          el.classList.add('selected');
          setTimeout(()=>{ el.classList.remove('selected'); moveTile(el, ans); }, 120);
        }
        return;
      }
      if(parent===ans){
        // tap in answer = move back to pool (before first wrong token if exists)
        moveTile(el, pool);
      }
    }

    function moveTile(el, target){
      el.classList.remove('correct','wrong');
      target.appendChild(el);
    }

    function currentAnswerTokens(){
      return $$('#row-answer .tile').map(n=>n.dataset.tok);
    }

    function check(){
      const cur = state.items[state.idx];
      const ansTokens = currentAnswerTokens();
      const full = ansTokens.length === cur.answer.length;
      const correct = full && eqTokens(ansTokens, cur.answer, {ignoreCase: state.options.case});
      // Mark tokens
      const nodes = $$('#row-answer .tile');
      nodes.forEach((n,i)=>{
        const expect = cur.answer[i];
        const got = n.dataset.tok;
        const ok = (state.options.case? String(got).toLowerCase() : got) === (state.options.case? String(expect).toLowerCase() : expect);
        n.classList.toggle('correct', ok);
        n.classList.toggle('wrong', !ok);
      });
      if(!full){
        $('#area-feedback').innerHTML = '<span class="text-amber-600">ã¾ã èªãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ«ã‚’è§£ç­”æ¬„ã¸ç§»å‹•ã—ã¦ãã ã•ã„ã€‚</span>';
        return;
      }
      if(correct){
        $('#area-feedback').innerHTML = '<span class="text-emerald-700 font-semibold">ğŸ‰ æ­£è§£ï¼</span>';
      } else {
        $('#area-feedback').innerHTML = '<span class="text-rose-700 font-semibold">âœ‹ ã‚‚ã†ä¸€æ­©ï¼</span> ã‚¿ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å…¥ã‚Œæ›¿ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
      }
    }

    function next(){
      if(state.idx < state.items.length-1){
        state.idx++;
        loadCurrent(true);
      } else {
        $('#area-feedback').innerHTML = '<span class="text-indigo-700 font-semibold">ãŠã—ã¾ã„ï¼</span> å³ä¸Šã®å…±æœ‰ãƒªãƒ³ã‚¯ã§åˆ¥ã®ã‚»ãƒƒãƒˆã‚’é…å¸ƒã§ãã¾ã™ã€‚';
      }
    }

    function resetRound(){
      loadCurrent(false);
    }

    function reshuffle(){
      loadCurrent(true);
    }

    function switchTo(tab){
      const a = $('#panel-author');
      const p = $('#panel-play');
      if(tab==='author'){ a.classList.remove('hidden'); p.classList.add('hidden'); }
      else { p.classList.remove('hidden'); a.classList.add('hidden'); }
    }

    function encodeShareURL(lines){
      const payload = encodeURIComponent(lines.join('\n'));
      const url = `${location.origin}${location.pathname}?s=${payload}`;
      return url;
    }

    function decodeShareParam(){
      const u = new URL(location.href);
      const s = u.searchParams.get('s');
      if(!s) return null;
      try { return decodeURIComponent(s); } catch { return null; }
    }

    function copy(text){
      navigator.clipboard.writeText(text).then(()=>{
        toast('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }).catch(()=>{
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚\n' + text);
      })
    }

    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white text-sm px-4 py-2 rounded-full shadow-lg';
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1600);
    }

    // --- Wire up ---
    $('#btn-build').addEventListener('click', buildFromTextarea);
    $('#btn-demo').addEventListener('click', ()=>{
      $('#input-sentences').value = `I have a dream today.\nReading books makes me happy.\nWhen I was a child, I lived in Sapporo.`;
    });
    $('#btn-export').addEventListener('click', ()=>{
      const text = $('#input-sentences').value.trim();
      if(!text) return alert('ã¾ãšè‹±æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      const lines = text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const url = encodeShareURL(lines);
      copy(url);
    });

    $('#btn-check').addEventListener('click', check);
    $('#btn-next').addEventListener('click', next);
    $('#btn-reset').addEventListener('click', resetRound);
    $('#btn-shuffle').addEventListener('click', reshuffle);

    $('#tab-author').addEventListener('click', ()=> switchTo('author'));
    $('#tab-play').addEventListener('click', ()=> switchTo('play'));

    // --- Auto-load if shared URL ---
    (function initFromURL(){
      const decoded = decodeShareParam();
      if(decoded){
        $('#input-sentences').value = decoded;
        buildFromTextarea();
        switchTo('play');
      }
    })();
  </script>
</body>
</html>
